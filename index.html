<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Day One Juz - Improved</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .date-info {
            color: #666;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active:hover {
            background: #0056b3;
        }

        .content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .stat-item.khatam {
            border-left-color: #28a745;
            background: #f8fff8;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-item.khatam .stat-number {
            color: #28a745;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .participants-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .participant-item:hover {
            border-color: #007bff;
        }

        .participant-item.completed {
            background: #f8fff8;
            border-color: #28a745;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            margin-right: 15px;
            cursor: pointer;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .juz-assignment {
            color: #666;
            font-size: 0.9em;
        }

        .completion-time {
            font-size: 0.8em;
            color: #28a745;
            margin-top: 5px;
        }

        .monthly-controls {
            margin-bottom: 20px;
        }

        .month-selector {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .report-table th,
        .report-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .report-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .report-table tr:hover {
            background: #f8f9fa;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }

        .hidden {
            display: none;
        }

        .firebase-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .firebase-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .firebase-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .khatam-celebration {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .participants-list {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>One Day One Juz</h1>
            <div class="date-info" id="currentDate"></div>
            <div id="firebaseStatus" class="firebase-status firebase-disconnected">
                Firebase: Tidak Terhubung
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('daily')">ðŸ“‹ Harian</button>
            <button class="tab" onclick="showTab('monthly')">ðŸ“Š Laporan Bulanan</button>
        </div>

        <div id="daily-content" class="content">
            <div id="khatamCelebration" class="khatam-celebration hidden">
                ðŸŽ‰ Alhamdulillah! Hari ini Al-Qur'an telah dikhatamkan bersama! ðŸŽ‰
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="todayCompleted">0</div>
                    <div class="stat-label">Selesai Hari Ini</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="todayTotal">30</div>
                    <div class="stat-label">Total Peserta</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="todayPercentage">0%</div>
                    <div class="stat-label">Persentase</div>
                </div>
                <div class="stat-item khatam">
                    <div class="stat-number" id="monthlyKhatam">0</div>
                    <div class="stat-label">Khatam Bulan Ini</div>
                </div>
            </div>

            <div class="participants-list" id="participantsList">
                <!-- Participants will be loaded here -->
            </div>
        </div>

        <div id="monthly-content" class="content hidden">
            <div class="monthly-controls">
                <select class="month-selector" id="monthSelector" onchange="updateMonthlyReport()">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <table class="report-table" id="monthlyTable">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Hari Selesai</th>
                        <th>Persentase</th>
                        <th>Progress</th>
                    </tr>
                </thead>
                <tbody id="monthlyTableBody">
                    <!-- Monthly data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSqs7LUpQ11h6qOB5exqXdAZVA4V3vfDA",
            authDomain: "odoj-40592.firebaseapp.com",
            databaseURL: "https://odoj-40592-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "odoj-40592",
            storageBucket: "odoj-40592.firebasestorage.app",
            messagingSenderId: "1086230605852",
            appId: "1:1086230605852:web:8a0eb2151a97da2d192fd9"
        };

        // Initialize Firebase
        let database;
        let isFirebaseConnected = false;

        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                // Test connection
                database.ref('.info/connected').on('value', (snapshot) => {
                    isFirebaseConnected = snapshot.val() === true;
                    updateFirebaseStatus();
                    
                    if (isFirebaseConnected) {
                        setupRealtimeListeners();
                        loadDataFromFirebase();
                    }
                });
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isFirebaseConnected = false;
                updateFirebaseStatus();
            }
        }

        function setupRealtimeListeners() {
            // Listen to all data changes
            const dataRef = database.ref('odoj');
            dataRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                
                // Update local data
                dailyProgress = data.dailyProgress || {};
                monthlyData = data.monthlyData || {};
                khatamCounter = data.khatamCounter || {};
                
                // Update UI
                renderParticipants();
                updateDailyStats();
                
                // Update monthly report if it's currently visible
                if (!document.getElementById('monthly-content').classList.contains('hidden')) {
                    updateMonthlyReport();
                }
            });
        }

        function loadDataFromFirebase() {
            if (!isFirebaseConnected) return;
            
            database.ref('odoj').once('value', (snapshot) => {
                const data = snapshot.val() || {};
                dailyProgress = data.dailyProgress || {};
                monthlyData = data.monthlyData || {};
                khatamCounter = data.khatamCounter || {};
                
                renderParticipants();
                updateDailyStats();
            });
        }

        function updateFirebaseStatus() {
            const statusEl = document.getElementById('firebaseStatus');
            if (isFirebaseConnected) {
                statusEl.textContent = 'Firebase: Terhubung';
                statusEl.className = 'firebase-status firebase-connected';
            } else {
                statusEl.textContent = 'Firebase: Tidak Terhubung (Mode Offline)';
                statusEl.className = 'firebase-status firebase-disconnected';
            }
        }

        // Data storage
        let participants = [
            { id: 1, name: 'Syafiq' },
            { id: 2, name: 'Fatimah' },
            { id: 3, name: 'Muhammad' },
            { id: 4, name: 'Aisyah' },
            { id: 5, name: 'Abdullah' },
            { id: 6, name: 'Khadijah' },
            { id: 7, name: 'Faruq' },
            { id: 8, name: 'Zainab' },
            { id: 9, name: 'Ali' },
            { id: 10, name: 'Hafshah' },
            { id: 11, name: 'Ibrahim' },
            { id: 12, name: 'Mamduh' },
            { id: 13, name: 'Ahmad' },
            { id: 14, name: 'Khoirunnisa' },
            { id: 15, name: 'Umar' },
            { id: 16, name: 'Ruqoyyah' },
            { id: 17, name: 'Yusuf' },
            { id: 18, name: 'Maryam' },
            { id: 19, name: 'Zakaria' },
            { id: 20, name: 'Aminah' },
            { id: 21, name: 'Sholeh' },
            { id: 22, name: 'Sholihah' },
            { id: 23, name: 'Hamzah' },
            { id: 24, name: 'Asiyah' },
            { id: 25, name: 'Bilal' },
            { id: 26, name: 'Sumayyah' },
            { id: 27, name: 'Salman' },
            { id: 28, name: 'Ummu Salamah' },
            { id: 29, name: 'Khalid' },
            { id: 30, name: 'Hafsah' }
        ];
        
        let dailyProgress = {};
        let monthlyData = {};
        let khatamCounter = {};

        // Save to Firebase
        function saveToFirebase() {
            if (!isFirebaseConnected) {
                console.log("Firebase not connected, data saved locally only");
                return;
            }
            
            try {
                database.ref('odoj').set({
                    dailyProgress: dailyProgress,
                    monthlyData: monthlyData,
                    khatamCounter: khatamCounter,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error saving to Firebase:", error);
            }
        }

        // Mendapatkan informasi tanggal saat ini
        function getCurrentDateInfo() {
            const now = new Date();
            const startDate = new Date('2025-01-01');
            const daysDiff = Math.floor((now - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            return {
                date: now.toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }),
                dayNumber: daysDiff,
                dateKey: now.toISOString().split('T')[0],
                monthKey: now.toISOString().slice(0, 7),
                year: now.getFullYear(),
                month: now.getMonth() + 1,
                day: now.getDate()
            };
        }

        // Sistem rotasi baru: setiap peserta mendapat juz yang sama setiap hari + bertambah setiap hari
        function getAssignmentForDay(dayNumber) {
            const assignments = [];
            
            // Untuk setiap peserta
            for (let i = 0; i < 30; i++) {
                // Juz untuk peserta = (posisi peserta + hari - 1) % 30 + 1
                const juz = ((i + dayNumber - 1) % 30) + 1;
                assignments.push({
                    juz: juz,
                    participant: participants[i]
                });
            }
            
            // Sort berdasarkan juz untuk tampilan yang rapi
            assignments.sort((a, b) => a.juz - b.juz);
            return assignments;
        }

        // Fungsi untuk mendapatkan jumlah hari dalam bulan
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // Render daftar peserta untuk hari ini
        function renderParticipants() {
            const dateInfo = getCurrentDateInfo();
            const assignments = getAssignmentForDay(dateInfo.dayNumber);
            const participantsList = document.getElementById('participantsList');
            
            participantsList.innerHTML = '';
            
            assignments.forEach(assignment => {
                const progressKey = `${dateInfo.dateKey}-${assignment.participant.id}-${assignment.juz}`;
                const isCompleted = dailyProgress[progressKey];
                
                const item = document.createElement('div');
                item.className = `participant-item ${isCompleted ? 'completed' : ''}`;
                
                item.innerHTML = `
                    <input type="checkbox" class="checkbox" 
                           ${isCompleted ? 'checked' : ''} 
                           onchange="toggleProgress(${assignment.participant.id}, ${assignment.juz})">
                    <div class="participant-info">
                        <div class="participant-name">${assignment.participant.name}</div>
                        <div class="juz-assignment">Juz ${assignment.juz}</div>
                        ${isCompleted ? `<div class="completion-time">âœ“ Selesai pada: ${new Date(isCompleted).toLocaleString('id-ID')}</div>` : ''}
                    </div>
                `;
                
                participantsList.appendChild(item);
            });
        }

        // Toggle progress peserta
        function toggleProgress(participantId, juz) {
            const dateInfo = getCurrentDateInfo();
            const progressKey = `${dateInfo.dateKey}-${participantId}-${juz}`;
            const monthlyKey = `${dateInfo.monthKey}-${participantId}`;
            
            if (dailyProgress[progressKey]) {
                // Remove completion
                delete dailyProgress[progressKey];
                
                // Update monthly data - decrease count
                if (monthlyData[monthlyKey] && monthlyData[monthlyKey].completedDays > 0) {
                    monthlyData[monthlyKey].completedDays--;
                }
            } else {
                // Add completion
                dailyProgress[progressKey] = new Date().toISOString();
                
                // Update monthly data - increase count
                if (!monthlyData[monthlyKey]) {
                    monthlyData[monthlyKey] = { 
                        completedDays: 0,
                        participantName: participants.find(p => p.id === participantId).name
                    };
                }
                monthlyData[monthlyKey].completedDays++;
            }
            
            // Check for khatam
            checkKhatam();
            
            // Save to Firebase (this will trigger real-time updates for other devices)
            saveToFirebase();
        }

        // Check if khatam is completed
        function checkKhatam() {
            const dateInfo = getCurrentDateInfo();
            const completedToday = Object.keys(dailyProgress).filter(key => 
                key.startsWith(dateInfo.dateKey) && !key.includes('khatam')
            ).length;
            
            const khatamKey = `${dateInfo.dateKey}-khatam`;
            
            if (completedToday === 30) {
                // Khatam completed!
                if (!dailyProgress[khatamKey]) {
                    if (!khatamCounter[dateInfo.monthKey]) {
                        khatamCounter[dateInfo.monthKey] = 0;
                    }
                    khatamCounter[dateInfo.monthKey]++;
                    dailyProgress[khatamKey] = true;
                    
                    // Show celebration
                    document.getElementById('khatamCelebration').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('khatamCelebration').classList.add('hidden');
                    }, 5000);
                }
            } else {
                // Remove khatam if exists (less than 30 completed)
                if (dailyProgress[khatamKey]) {
                    delete dailyProgress[khatamKey];
                    if (khatamCounter[dateInfo.monthKey] > 0) {
                        khatamCounter[dateInfo.monthKey]--;
                    }
                }
            }
        }

        // Update statistik harian
        function updateDailyStats() {
            const dateInfo = getCurrentDateInfo();
            const completedToday = Object.keys(dailyProgress).filter(key => 
                key.startsWith(dateInfo.dateKey) && !key.includes('khatam')
            ).length;
            
            const percentage = Math.round((completedToday / 30) * 100);
            const monthlyKhatam = khatamCounter[dateInfo.monthKey] || 0;
            
            document.getElementById('todayCompleted').textContent = completedToday;
            document.getElementById('todayPercentage').textContent = percentage + '%';
            document.getElementById('monthlyKhatam').textContent = monthlyKhatam;
        }

        // Show tab
        function showTab(tabName) {
            // Hide all content
            document.getElementById('daily-content').classList.add('hidden');
            document.getElementById('monthly-content').classList.add('hidden');
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content and activate tab
            document.getElementById(tabName + '-content').classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tabName === 'monthly') {
                initMonthlyReport();
            }
        }

        // Inisialisasi laporan bulanan
        function initMonthlyReport() {
            const monthSelector = document.getElementById('monthSelector');
            const currentDate = new Date();
            
            // Populate month options
            monthSelector.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toISOString().slice(0, 7);
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                if (i === 0) option.selected = true;
                monthSelector.appendChild(option);
            }
            
            updateMonthlyReport();
        }

        // Update laporan bulanan
        function updateMonthlyReport() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const tbody = document.getElementById('monthlyTableBody');
            const year = parseInt(selectedMonth.split('-')[0]);
            const month = parseInt(selectedMonth.split('-')[1]);
            
            // Menggunakan fungsi getDaysInMonth untuk mendapatkan jumlah hari sebenarnya
            const daysInMonth = getDaysInMonth(year, month);
            
            tbody.innerHTML = '';
            
            participants.forEach(participant => {
                const monthlyKey = `${selectedMonth}-${participant.id}`;
                const participantData = monthlyData[monthlyKey] || { completedDays: 0 };
                
                const completedDays = participantData.completedDays || 0;
                const percentage = Math.round((completedDays / daysInMonth) * 100);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${participant.name}</td>
                    <td>${completedDays}/${daysInMonth}</td>
                    <td>${percentage}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Inisialisasi aplikasi
        function init() {
            // Initialize Firebase
            initFirebase();
            
            const dateInfo = getCurrentDateInfo();
            document.getElementById('currentDate').textContent = dateInfo.date;
            
            // Initial render (will be updated when Firebase connects)
            renderParticipants();
            updateDailyStats();
        }

        // Mulai aplikasi
        init();
    </script>
</body>
</html>
